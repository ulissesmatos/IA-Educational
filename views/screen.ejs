<!DOCTYPE html>
<html lang="pt-BR">
<%- include('partials/head', { title }) %>
<body class="gradient-bg">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    /* Layout base */
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    .screen-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem 2rem;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }
    
    .screen-header {
      text-align: center;
      padding-bottom: 1rem;
      flex-shrink: 0;
    }
    
    .screen-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    /* Sections - all hidden by default */
    .screen-section {
      display: none;
      width: 100%;
      height: 100%;
    }
    
    .screen-section.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Lobby specific */
    .lobby-card {
      width: 100%;
      max-width: 900px;
    }
    
    /* Question/Result grid */
    .game-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      width: 100%;
      max-width: 1200px;
      align-self: flex-start;
      padding-top: 1rem;
    }
    
    .game-grid.active {
      display: grid;
    }
    
    /* Typography */
    .screen-title {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .screen-room-code {
      font-family: monospace;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--accent-primary);
      letter-spacing: 0.15em;
    }
    
    /* QR Code */
    .qr-container {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      display: inline-block;
    }
    
    .qr-container canvas {
      display: block;
    }
    
    /* Stats bars */
    .stat-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
    }
    
    .stat-letter {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--bg-tertiary);
      font-weight: 700;
      font-size: 1.125rem;
    }
    
    .stat-letter.correct {
      background: var(--success);
      color: white;
    }
    
    .stat-bar-wrapper {
      flex: 1;
      height: 1.25rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .stat-bar-fill {
      height: 100%;
      background: var(--accent-primary);
      border-radius: var(--radius-full);
      transition: width 0.5s ease;
    }
    
    .stat-bar-fill.correct {
      background: var(--success);
    }
    
    .stat-percentage {
      font-weight: 600;
      min-width: 3.5rem;
      text-align: right;
    }
    
    /* Ranking items */
    .rank-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem 1rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
    }
    
    .rank-item.gold { background: linear-gradient(135deg, rgba(245,184,0,0.15), rgba(245,184,0,0.05)); border: 1px solid rgba(245,184,0,0.3); }
    .rank-item.silver { background: linear-gradient(135deg, rgba(192,192,192,0.15), rgba(192,192,192,0.05)); border: 1px solid rgba(192,192,192,0.3); }
    .rank-item.bronze { background: linear-gradient(135deg, rgba(205,127,50,0.15), rgba(205,127,50,0.05)); border: 1px solid rgba(205,127,50,0.3); }
    
    .rank-medal {
      font-size: 1.25rem;
    }
    
    .rank-name {
      flex: 1;
      font-weight: 500;
    }
    
    .rank-score {
      font-weight: 700;
      color: var(--accent-primary);
    }
    
    /* Player avatars */
    .player-bubble {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: var(--accent-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
    }
    
    /* Answer callout */
    .answer-box {
      padding: 1rem;
      border-radius: var(--radius-lg);
      margin-bottom: 0.75rem;
    }
    
    .answer-box.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .answer-box.info {
      background: rgba(0, 201, 224, 0.1);
      border: 1px solid rgba(0, 201, 224, 0.3);
    }
    
    /* Background decoration */
    .bg-decoration {
      position: fixed;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }
    
    .bg-decoration::before,
    .bg-decoration::after {
      content: '';
      position: absolute;
      border-radius: 50%;
    }
    
    .bg-decoration::before {
      top: -30%;
      left: -20%;
      width: 60%;
      height: 60%;
      background: radial-gradient(circle, var(--accent-10) 0%, transparent 60%);
    }
    
    .bg-decoration::after {
      bottom: -30%;
      right: -20%;
      width: 70%;
      height: 70%;
      background: radial-gradient(circle, var(--accent-20) 0%, transparent 60%);
    }
    
    /* Confetti */
    .confetti-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }
    
    .confetti-piece {
      position: absolute;
    }
  </style>

  <!-- Background -->
  <div class="bg-decoration"></div>

  <div class="screen-container">
    
    <!-- Header -->
    <header class="screen-header">
      <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
        <span style="color: var(--accent-primary);"><%- include('icons/cpu-chip', { size: 48 }) %></span>
        <h1 class="screen-title"><%= gameName %></h1>
      </div>
      <p style="color: var(--text-secondary);">
        Sala: <span class="screen-room-code"><%= roomCode %></span>
      </p>
    </header>

    <!-- Main Content -->
    <main class="screen-main">
      
      <!-- ========== LOBBY ========== -->
      <section id="sec-lobby" class="screen-section active">
        <div class="lobby-card">
          <div class="card" style="padding: 2rem;">
            
            <h2 class="text-headline mb-4" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <%- include('icons/clock', { size: 24 }) %>
              Aguardando Participantes
            </h2>
            
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: center; margin-bottom: 1.5rem;">
              
              <!-- Instructions -->
              <div style="text-align: left;">
                <h3 class="text-title mb-3" style="color: var(--accent-primary);">Como participar:</h3>
                
                <div class="mb-3">
                  <p class="text-small text-muted mb-1">1. Acesse pelo celular:</p>
                  <p id="join-url" style="font-family: monospace; color: var(--accent-primary); font-weight: 600; font-size: 1.125rem;"></p>
                </div>
                
                <div class="mb-3">
                  <p class="text-small text-muted mb-1">2. Digite o cÃ³digo:</p>
                  <p style="font-family: monospace; font-weight: 700; color: var(--accent-primary); font-size: 2rem; letter-spacing: 0.2em;"><%= roomCode %></p>
                </div>
                
                <div style="background: var(--accent-subtle); border: 1px solid var(--accent-20); border-radius: var(--radius-lg); padding: 1rem; margin-top: 1rem;">
                  <p style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <%- include('icons/users', { size: 20 }) %>
                    <span id="player-count" style="font-weight: 700; font-size: 1.5rem; color: var(--accent-primary);">0</span>
                    <span class="text-secondary">participantes conectados</span>
                  </p>
                </div>
              </div>
              
              <!-- QR Code -->
              <div style="text-align: center;">
                <div class="qr-container" id="qr-container"></div>
                <p class="text-small text-muted" style="margin-top: 0.5rem;">Escaneie para entrar</p>
              </div>
            </div>
            
            <!-- Players -->
            <div id="player-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem;"></div>
            
          </div>
        </div>
      </section>

      <!-- ========== QUESTION ========== -->
      <section id="sec-question" class="screen-section">
        <div class="game-grid">
          
          <!-- Main content -->
          <div>
            <div class="card" style="padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span id="q-type" class="badge badge-primary"></span>
                <span id="q-counter" class="badge badge-neutral"></span>
              </div>
              
              <div id="q-image-wrap" style="display: none; margin-bottom: 1rem;">
                <img id="q-image" src="" alt="" style="width: 100%; max-height: 280px; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary);">
              </div>
              
              <!-- Compare Images (for IMAGE_COMPARE type) -->
              <div id="q-images-compare" style="display: none; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                  <div style="text-align: center;">
                    <p style="font-weight: 700; margin-bottom: 0.75rem; color: var(--accent-primary); font-size: 1.25rem;">Imagem A</p>
                    <img id="q-image-a" src="" alt="Imagem A" style="width: 100%; max-height: 260px; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary); border: 3px solid var(--border-color);">
                  </div>
                  <div style="text-align: center;">
                    <p style="font-weight: 700; margin-bottom: 0.75rem; color: var(--accent-primary); font-size: 1.25rem;">Imagem B</p>
                    <img id="q-image-b" src="" alt="Imagem B" style="width: 100%; max-height: 260px; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary); border: 3px solid var(--border-color);">
                  </div>
                </div>
              </div>
              
              <p id="q-prompt" class="text-body mb-4" style="white-space: pre-line; font-size: 1.0625rem;"></p>
              
              <div id="q-options"></div>
            </div>
          </div>
          
          <!-- Sidebar -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            
            <!-- Response counter -->
            <div class="card" style="padding: 1.25rem; text-align: center;">
              <h3 class="text-title mb-3" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <%- include('icons/chart-bar', { size: 20 }) %> Respostas
              </h3>
              <p style="font-size: 3rem; font-weight: 800; color: var(--accent-primary); line-height: 1;">
                <span id="answered">0</span>/<span id="total">0</span>
              </p>
              <p class="text-small text-muted">responderam</p>
            </div>
            
            <!-- Ranking -->
            <div class="card" style="padding: 1.25rem; flex: 1;">
              <h3 class="text-title mb-3" style="display: flex; align-items: center; gap: 0.5rem;">
                <%- include('icons/trophy', { size: 20 }) %> Top 5
              </h3>
              <div id="q-ranking"></div>
            </div>
            
          </div>
        </div>
      </section>

      <!-- ========== RESULT ========== -->
      <section id="sec-result" class="screen-section">
        <div class="game-grid">
          
          <!-- Main content -->
          <div>
            <div class="card" style="padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span id="r-type" class="badge badge-primary"></span>
                <span id="r-counter" class="badge badge-neutral"></span>
              </div>
              
              <div id="r-image-wrap" style="display: none; margin-bottom: 1rem;">
                <img id="r-image" src="" alt="" style="width: 100%; max-height: 180px; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary);">
              </div>
              
              <!-- Compare Images for Result (IMAGE_COMPARE type) -->
              <div id="r-images-compare" style="display: none; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div style="text-align: center;">
                    <p style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary);">Imagem A</p>
                    <img id="r-image-a" src="" alt="Imagem A" style="width: 100%; max-height: 150px; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary); border: 2px solid var(--border-color);">
                  </div>
                  <div style="text-align: center;">
                    <p style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary);">Imagem B</p>
                    <img id="r-image-b" src="" alt="Imagem B" style="width: 100%; max-height: 150px; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary); border: 2px solid var(--border-color);">
                  </div>
                </div>
              </div>
              
              <p id="r-prompt" class="text-body mb-3" style="white-space: pre-line; color: var(--text-secondary);"></p>
              
              <!-- Stats -->
              <div id="r-stats" class="mb-4"></div>
              
              <!-- Correct answer -->
              <div class="answer-box success">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                  <span style="color: var(--success);"><%- include('icons/check-circle', { size: 24 }) %></span>
                  <div>
                    <p class="text-small" style="color: var(--success); margin-bottom: 0.25rem;">Resposta Correta</p>
                    <p id="r-answer" class="text-title" style="font-weight: 600;"></p>
                  </div>
                </div>
              </div>
              
              <!-- Explanation -->
              <div class="answer-box info">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                  <span style="color: var(--accent-primary);"><%- include('icons/light-bulb', { size: 24 }) %></span>
                  <div>
                    <p class="text-small" style="color: var(--accent-primary); margin-bottom: 0.25rem;">ExplicaÃ§Ã£o</p>
                    <p id="r-explanation" class="text-body" style="color: var(--text-secondary);"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sidebar -->
          <div>
            <div class="card" style="padding: 1.25rem;">
              <h3 class="text-title mb-3" style="display: flex; align-items: center; gap: 0.5rem;">
                <%- include('icons/trophy', { size: 20 }) %> Ranking
              </h3>
              <div id="r-ranking"></div>
            </div>
          </div>
          
        </div>
      </section>

      <!-- ========== GAME OVER ========== -->
      <section id="sec-gameover" class="screen-section">
        <div style="text-align: center; width: 100%; max-width: 600px;">
          <div class="card" style="padding: 2.5rem;">
            
            <div style="color: var(--golden); margin-bottom: 1.5rem;">
              <%- include('icons/trophy', { size: 72 }) %>
            </div>
            
            <h2 class="text-display mb-4">Fim do Jogo!</h2>
            
            <h3 class="text-headline mb-4" style="color: var(--accent-primary);">ðŸŽ‰ Ranking Final</h3>
            
            <div id="final-ranking"></div>
            
            <p class="text-body text-muted" style="margin-top: 2rem;">Obrigado por participar!</p>
            
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Confetti -->
  <div id="confetti-container" class="confetti-container"></div>

  <script>
    // ==================== INITIALIZATION ====================
    const roomCode = '<%= roomCode %>';
    const joinUrl = window.location.origin + '/join?code=' + roomCode;
    
    // Set join URL
    document.getElementById('join-url').textContent = joinUrl;
    
    // Generate QR Code
    const qrContainer = document.getElementById('qr-container');
    if (typeof QRCode !== 'undefined') {
      new QRCode(qrContainer, {
        text: joinUrl,
        width: 180,
        height: 180,
        colorDark: '#0B1E3F',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // ==================== SECTIONS ====================
    const sections = {
      lobby: document.getElementById('sec-lobby'),
      question: document.getElementById('sec-question'),
      result: document.getElementById('sec-result'),
      gameover: document.getElementById('sec-gameover')
    };

    function showSection(name) {
      console.log('ðŸ“º Showing section:', name);
      Object.values(sections).forEach(s => s.classList.remove('active'));
      if (sections[name]) {
        sections[name].classList.add('active');
      }
    }

    // ==================== SOCKET CONNECTION ====================
    const socket = io();
    socket.emit('host:join', { roomCode });

    socket.on('room:state', handleState);
    socket.on('player:joined', (p) => console.log('ðŸ‘¤ Player joined:', p.nickname));
    socket.on('player:answered', updateAnswerCount);
    socket.on('game:ended', handleGameOver);
    socket.on('error', (e) => console.error('âŒ Socket error:', e.message));

    // ==================== STATE HANDLER ====================
    function handleState(state) {
      console.log('ðŸ“¡ State received:', state.status, state);
      
      // Update rankings everywhere
      renderRanking(state.ranking, 'q-ranking');
      renderRanking(state.ranking, 'r-ranking');

      switch (state.status) {
        case 'lobby':
          showSection('lobby');
          renderLobby(state);
          break;
          
        case 'asking':
          if (state.currentQuestion) {
            showSection('question');
            renderQuestion(state);
          }
          break;
          
        case 'revealed':
          if (state.revealedQuestion) {
            showSection('result');
            renderResult(state);
          }
          break;
      }
    }

    // ==================== RENDER FUNCTIONS ====================
    function renderLobby(state) {
      document.getElementById('player-count').textContent = state.players.length;
      
      const html = state.players.map(p => 
        `<div class="player-bubble">${p.nickname.charAt(0).toUpperCase()}</div>`
      ).join('');
      document.getElementById('player-list').innerHTML = html;
    }

    function renderQuestion(state) {
      const q = state.currentQuestion;
      
      const types = {
        'IMAGE_CLASSIFY': 'ðŸ–¼ï¸ Imagem',
        'IMAGE_COMPARE': 'ðŸ–¼ï¸ðŸ†šðŸ–¼ï¸ Compare',
        'TEXT_CLASSIFY': 'ðŸ“ Texto',
        'HALLUCINATION_DETECT': 'ðŸ” AlucinaÃ§Ã£o',
        'LGPD_TRAFFIC_LIGHT': 'ðŸš¦ LGPD'
      };
      
      document.getElementById('q-type').textContent = types[q.type] || q.type;
      document.getElementById('q-counter').textContent = `${q.index + 1} de ${q.total}`;
      document.getElementById('q-prompt').textContent = q.prompt;
      
      // Image handling
      const imgWrap = document.getElementById('q-image-wrap');
      const imgCompare = document.getElementById('q-images-compare');
      
      if (q.type === 'IMAGE_COMPARE' && q.imageUrl && q.imageUrl2) {
        // Show side-by-side images
        imgWrap.style.display = 'none';
        imgCompare.style.display = 'block';
        document.getElementById('q-image-a').src = q.imageUrl;
        document.getElementById('q-image-b').src = q.imageUrl2;
      } else if (q.imageUrl) {
        imgWrap.style.display = 'block';
        imgCompare.style.display = 'none';
        document.getElementById('q-image').src = q.imageUrl;
      } else {
        imgWrap.style.display = 'none';
        imgCompare.style.display = 'none';
      }
      
      // Options
      const optionsHtml = q.options.map((opt, i) => `
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
          <span style="width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; background: var(--accent-subtle); border-radius: 50%; font-weight: 600; color: var(--accent-primary);">${String.fromCharCode(65 + i)}</span>
          <span>${opt}</span>
        </div>
      `).join('');
      document.getElementById('q-options').innerHTML = optionsHtml;
      
      // Counters
      document.getElementById('answered').textContent = state.answeredCount;
      document.getElementById('total').textContent = state.totalPlayers;
    }

    function renderResult(state) {
      const q = state.revealedQuestion;
      
      const types = {
        'IMAGE_CLASSIFY': 'ðŸ–¼ï¸ Imagem',
        'IMAGE_COMPARE': 'ðŸ–¼ï¸ðŸ†šðŸ–¼ï¸ Compare',
        'TEXT_CLASSIFY': 'ðŸ“ Texto',
        'HALLUCINATION_DETECT': 'ðŸ” AlucinaÃ§Ã£o',
        'LGPD_TRAFFIC_LIGHT': 'ðŸš¦ LGPD'
      };
      
      document.getElementById('r-type').textContent = types[q.type] || q.type;
      document.getElementById('r-counter').textContent = `${q.index + 1} de ${q.total}`;
      document.getElementById('r-prompt').textContent = q.prompt;
      
      // Image handling
      const imgWrap = document.getElementById('r-image-wrap');
      const imgCompare = document.getElementById('r-images-compare');
      
      if (q.type === 'IMAGE_COMPARE' && q.imageUrl && q.imageUrl2) {
        // Show side-by-side images
        imgWrap.style.display = 'none';
        imgCompare.style.display = 'block';
        document.getElementById('r-image-a').src = q.imageUrl;
        document.getElementById('r-image-b').src = q.imageUrl2;
      } else if (q.imageUrl) {
        imgWrap.style.display = 'block';
        imgCompare.style.display = 'none';
        document.getElementById('r-image').src = q.imageUrl;
      } else {
        imgWrap.style.display = 'none';
        imgCompare.style.display = 'none';
      }
      
      // Stats
      const statsHtml = q.stats.map((s, i) => {
        const isCorrect = i === q.correctOption;
        return `
          <div class="stat-row">
            <span class="stat-letter ${isCorrect ? 'correct' : ''}">${String.fromCharCode(65 + i)}</span>
            <div class="stat-bar-wrapper">
              <div class="stat-bar-fill ${isCorrect ? 'correct' : ''}" style="width: ${s.percentage}%;"></div>
            </div>
            <span class="stat-percentage">${s.percentage}%</span>
            <span class="text-small text-muted">(${s.count})</span>
          </div>
        `;
      }).join('');
      document.getElementById('r-stats').innerHTML = statsHtml;
      
      // Correct answer
      document.getElementById('r-answer').textContent = 
        `${String.fromCharCode(65 + q.correctOption)}) ${q.options[q.correctOption]}`;
      
      // Explanation
      document.getElementById('r-explanation').textContent = q.explanation;
    }

    function renderRanking(ranking, elementId) {
      const el = document.getElementById(elementId);
      if (!el) return;
      
      if (!ranking || ranking.length === 0) {
        el.innerHTML = '<p class="text-small text-center text-muted" style="padding: 1rem;">Aguardando...</p>';
        return;
      }
      
      const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
      const html = ranking.slice(0, 5).map((p, i) => {
        let cls = '';
        if (i === 0) cls = 'gold';
        else if (i === 1) cls = 'silver';
        else if (i === 2) cls = 'bronze';
        
        return `
          <div class="rank-item ${cls}">
            <span class="rank-medal">${medals[i]}</span>
            <span class="rank-name">${p.nickname}</span>
            <span class="rank-score">${p.score}</span>
          </div>
        `;
      }).join('');
      
      el.innerHTML = html;
    }

    function updateAnswerCount(data) {
      document.getElementById('answered').textContent = data.answeredCount;
      document.getElementById('total').textContent = data.totalPlayers;
    }

    function handleGameOver(data) {
      showSection('gameover');
      
      const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];
      const html = data.ranking.slice(0, 10).map((p, i) => {
        let cls = '';
        if (i === 0) cls = 'gold';
        else if (i === 1) cls = 'silver';
        else if (i === 2) cls = 'bronze';
        
        return `
          <div class="rank-item ${cls}">
            <span class="rank-medal">${medals[i]}</span>
            <span class="rank-name">${p.nickname}</span>
            <span class="rank-score">${p.score} pts</span>
          </div>
        `;
      }).join('');
      
      document.getElementById('final-ranking').innerHTML = html;
      
      // Celebration
      createConfetti(50);
    }

    // ==================== CONFETTI ====================
    function createConfetti(count) {
      const container = document.getElementById('confetti-container');
      const colors = ['#00C9E0', '#F5B800', '#22C55E', '#FF6B35', '#3B82F6', '#A855F7'];
      
      for (let i = 0; i < count; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random() * 100 + '%';
        piece.style.top = '-20px';
        piece.style.width = (8 + Math.random() * 12) + 'px';
        piece.style.height = (8 + Math.random() * 12) + 'px';
        piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        
        container.appendChild(piece);
        
        piece.animate([
          { opacity: 1, transform: 'translateY(0) rotate(0deg)' },
          { opacity: 0, transform: `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 1080}deg)` }
        ], {
          duration: 3000 + Math.random() * 3000,
          easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
          delay: i * 30
        }).onfinish = () => piece.remove();
      }
    }
  </script>
</body>
</html>
