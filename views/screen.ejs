<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/custom.css">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* Screen-specific overrides for projector display */
    html, body {
      overflow: hidden;
      cursor: none;
    }
    
    .screen-text-huge {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    
    .screen-text-large {
      font-size: clamp(1.5rem, 3vw, 2.5rem);
      font-weight: 600;
    }
    
    .screen-text-medium {
      font-size: clamp(1.25rem, 2vw, 1.75rem);
    }
    
    .screen-text-body {
      font-size: clamp(1rem, 1.5vw, 1.5rem);
      line-height: 1.6;
    }
    
    .screen-badge {
      padding: 0.75rem 1.5rem;
      font-size: clamp(0.875rem, 1.25vw, 1.25rem);
    }
    
    .screen-option {
      padding: 1.25rem 1.5rem;
      font-size: clamp(1rem, 1.5vw, 1.5rem);
    }
    
    .screen-stat-bar {
      height: 2.5rem;
    }
    
    .screen-ranking-item {
      padding: 1rem 1.5rem;
      font-size: clamp(1rem, 1.5vw, 1.5rem);
    }
    
    .screen-ranking-position {
      font-size: clamp(1.5rem, 2vw, 2.5rem);
    }
    
    /* Animated background gradient */
    .animated-bg {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0B1220 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    /* Pulse glow effect for waiting states */
    .glow-pulse {
      animation: glowPulse 2s ease-in-out infinite;
    }
    
    @keyframes glowPulse {
      0%, 100% { 
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
      }
      50% { 
        box-shadow: 0 0 60px rgba(59, 130, 246, 0.5), 0 0 100px rgba(59, 130, 246, 0.2);
      }
    }
  </style>
</head>
<body class="animated-bg min-h-screen screen-mode" style="padding: 2rem;">
  
  <!-- Background Decoration -->
  <div style="position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 0;">
    <div style="position: absolute; top: -30%; left: -20%; width: 60%; height: 60%; background: radial-gradient(circle, rgba(37, 99, 235, 0.08) 0%, transparent 60%);"></div>
    <div style="position: absolute; bottom: -30%; right: -20%; width: 70%; height: 70%; background: radial-gradient(circle, rgba(96, 165, 250, 0.08) 0%, transparent 60%);"></div>
  </div>

  <div style="max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; height: calc(100vh - 4rem); display: flex; flex-direction: column;">
    
    <!-- Header -->
    <header class="text-center" style="margin-bottom: 2rem; flex-shrink: 0;">
      <div class="flex items-center justify-center gap-4 mb-2">
        <span style="color: var(--accent-light);"><%- include('icons/cpu-chip', { size: 64 }) %></span>
        <h1 class="screen-text-huge gradient-text">IA ou N√£o?</h1>
      </div>
      <p class="screen-text-medium" style="color: var(--text-secondary);">
        Sala: <span style="font-family: monospace; font-weight: 700; color: var(--accent-light); letter-spacing: 0.15em;"><%= roomCode %></span>
      </p>
    </header>

    <!-- Main Content Area -->
    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
      
      <!-- ==================== LOBBY STATE ==================== -->
      <div id="lobby-section" class="animate-fadeInUp" style="flex: 1; display: flex; flex-direction: column;">
        <div class="card glow-pulse text-center" style="flex: 1; padding: 3rem; display: flex; flex-direction: column; justify-content: center;">
          
          <div class="animate-float" style="margin-bottom: 2rem; color: var(--accent-light);">
            <%- include('icons/clock', { size: 128 }) %>
          </div>
          
          <h2 class="screen-text-huge mb-4" style="color: var(--text-primary);">Aguardando Participantes</h2>
          
          <!-- Join Instructions -->
          <div style="background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: var(--radius-xl); padding: 2rem; margin: 2rem auto; max-width: 600px;">
            <p class="screen-text-medium" style="color: var(--accent-light); margin-bottom: 0.5rem;">Entre pelo celular em:</p>
            <p id="join-url" class="screen-text-huge" style="font-family: monospace; color: var(--text-primary); word-break: break-all;"></p>
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(59, 130, 246, 0.2);">
              <p class="screen-text-medium" style="color: var(--text-secondary);">
                C√≥digo: <span style="font-family: monospace; font-weight: 700; color: var(--accent-light); font-size: 1.5em;"><%= roomCode %></span>
              </p>
            </div>
          </div>
          
          <!-- Player Count -->
          <div style="margin-top: 2rem;">
            <p class="screen-text-medium" style="color: var(--text-secondary); margin-bottom: 1rem;">Participantes conectados</p>
            <p id="lobby-player-count" class="screen-text-huge" style="color: var(--accent-light);">0</p>
          </div>
          
          <!-- Player Avatars -->
          <div id="lobby-players" class="flex flex-wrap justify-center gap-3" style="margin-top: 2rem;"></div>
        </div>
      </div>

      <!-- ==================== QUESTION STATE ==================== -->
      <div id="question-section" class="hidden" style="flex: 1; display: flex; gap: 2rem;">
        
        <!-- Main: Question -->
        <div style="flex: 2; display: flex; flex-direction: column;">
          <div class="card animate-fadeInUp" style="flex: 1; padding: 2rem; display: flex; flex-direction: column;">
            
            <!-- Question Header -->
            <div class="flex justify-between items-center" style="margin-bottom: 1.5rem;">
              <span id="question-type" class="badge badge-primary screen-badge"></span>
              <span id="question-counter" class="badge badge-neutral screen-badge"></span>
            </div>
            
            <!-- Question Image -->
            <div id="question-image" class="hidden" style="margin-bottom: 1.5rem; flex-shrink: 0;">
              <img id="question-img" src="" alt="Imagem da pergunta" 
                   style="width: 100%; max-height: 40vh; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary);">
            </div>
            
            <!-- Question Text -->
            <p id="question-prompt" class="screen-text-body" style="white-space: pre-line; flex: 1; display: flex; align-items: center;"></p>
            
            <!-- Options (display only, not interactive) -->
            <div id="options-container" class="space-y-3" style="margin-top: 2rem;"></div>
          </div>
        </div>
        
        <!-- Sidebar: Status + Ranking -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 300px;">
          
          <!-- Response Status -->
          <div class="card animate-fadeInUp" style="padding: 1.5rem; animation-delay: 100ms;">
            <h3 class="screen-text-medium mb-4" style="display: flex; align-items: center; gap: 0.75rem;">
              <%- include('icons/chart-bar', { size: 24 }) %> Respostas
            </h3>
            <div class="text-center">
              <p style="font-size: clamp(3rem, 5vw, 5rem); font-weight: 800; color: var(--accent-light);">
                <span id="answered-count">0</span>/<span id="total-players">0</span>
              </p>
              <p class="text-caption" style="margin-top: 0.5rem;">responderam</p>
            </div>
            <div id="waiting-indicator" class="text-center animate-pulse" style="margin-top: 1.5rem;">
              <span style="color: var(--accent-light);"><%- include('icons/clock', { size: 32 }) %></span>
              <p class="text-caption">Aguardando...</p>
            </div>
          </div>
          
          <!-- Ranking -->
          <div class="card animate-fadeInUp" style="padding: 1.5rem; flex: 1; animation-delay: 150ms;">
            <h3 class="screen-text-medium mb-4" style="display: flex; align-items: center; gap: 0.75rem;">
              <%- include('icons/trophy', { size: 24 }) %> Top 5
            </h3>
            <div id="ranking-list" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- ==================== RESULT STATE ==================== -->
      <div id="result-section" class="hidden" style="flex: 1; display: flex; gap: 2rem;">
        
        <!-- Main: Result -->
        <div style="flex: 2; display: flex; flex-direction: column;">
          <div class="card animate-scaleIn" style="flex: 1; padding: 2rem; display: flex; flex-direction: column;">
            
            <!-- Header -->
            <div class="flex justify-between items-center" style="margin-bottom: 1.5rem;">
              <span id="result-type" class="badge badge-primary screen-badge"></span>
              <span id="result-counter" class="badge badge-neutral screen-badge"></span>
            </div>
            
            <!-- Image (smaller in result) -->
            <div id="result-image" class="hidden" style="margin-bottom: 1rem;">
              <img id="result-img" src="" alt="Imagem" 
                   style="width: 100%; max-height: 25vh; object-fit: contain; border-radius: var(--radius-lg); background: var(--bg-tertiary);">
            </div>
            
            <!-- Question Text -->
            <p id="result-prompt" class="screen-text-body" style="white-space: pre-line; margin-bottom: 1.5rem; color: var(--text-secondary);"></p>
            
            <!-- Stats -->
            <div id="stats-container" class="space-y-3" style="margin-bottom: 1.5rem;"></div>
            
            <!-- Correct Answer -->
            <div class="callout callout-success" style="padding: 1.5rem; margin-bottom: 1rem;">
              <span class="callout-icon" style="font-size: 2rem;"><%- include('icons/check-circle', { size: 32 }) %></span>
              <div class="callout-content">
                <p class="screen-text-medium" style="color: var(--success-light); margin-bottom: 0.25rem;">Resposta Correta</p>
                <p id="correct-answer" class="screen-text-large" style="font-weight: 700;"></p>
              </div>
            </div>
            
            <!-- Explanation -->
            <div class="callout callout-info" style="padding: 1.5rem; flex: 1;">
              <span class="callout-icon" style="font-size: 1.5rem;"><%- include('icons/light-bulb', { size: 24 }) %></span>
              <div class="callout-content">
                <p class="screen-text-medium" style="margin-bottom: 0.5rem;">Explica√ß√£o</p>
                <p id="explanation" class="screen-text-body" style="color: var(--text-secondary);"></p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sidebar: Updated Ranking -->
        <div style="flex: 1; display: flex; flex-direction: column; min-width: 300px;">
          <div class="card animate-fadeInUp" style="padding: 1.5rem; flex: 1; animation-delay: 200ms;">
            <h3 class="screen-text-medium mb-4" style="display: flex; align-items: center; gap: 0.75rem;">
              <%- include('icons/trophy', { size: 24 }) %> Ranking Atualizado
            </h3>
            <div id="result-ranking" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- ==================== GAME OVER STATE ==================== -->
      <div id="gameover-section" class="hidden" style="flex: 1; display: flex; flex-direction: column;">
        <div class="card animate-scaleIn text-center" style="flex: 1; padding: 3rem; display: flex; flex-direction: column; justify-content: center;">
          
          <div class="animate-float" style="margin-bottom: 2rem; color: var(--warning);">
            <%- include('icons/trophy', { size: 160 }) %>
          </div>
          
          <h2 class="screen-text-huge mb-6" style="color: var(--text-primary);">Fim do Jogo!</h2>
          
          <!-- Final Ranking -->
          <div style="max-width: 700px; margin: 0 auto; width: 100%;">
            <h3 class="screen-text-large mb-4" style="color: var(--accent-light);">üéâ Ranking Final</h3>
            <div id="final-ranking" class="space-y-3"></div>
          </div>
          
          <div style="margin-top: 3rem;">
            <p class="screen-text-medium" style="color: var(--text-muted);">Obrigado por participar!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confetti Container -->
  <div id="confetti-container" class="confetti-container"></div>

  <script>
    const roomCode = '<%= roomCode %>';
    
    // Set join URL
    document.getElementById('join-url').textContent = window.location.origin + '/join';

    let socket = null;

    // DOM Elements
    const lobbySection = document.getElementById('lobby-section');
    const questionSection = document.getElementById('question-section');
    const resultSection = document.getElementById('result-section');
    const gameoverSection = document.getElementById('gameover-section');

    // Connect as host to receive updates
    socket = io();
    socket.emit('host:join', { roomCode });

    socket.on('room:state', updateState);
    socket.on('player:joined', (player) => {
      console.log('New player:', player.nickname);
    });
    socket.on('player:answered', (data) => {
      document.getElementById('answered-count').textContent = data.answeredCount;
      document.getElementById('total-players').textContent = data.totalPlayers;
    });
    socket.on('game:ended', showGameOver);
    socket.on('error', (data) => console.error('Error:', data.message));

    function updateState(state) {
      console.log('State:', state);
      
      // Hide all sections
      lobbySection.classList.add('hidden');
      questionSection.classList.add('hidden');
      resultSection.classList.add('hidden');
      gameoverSection.classList.add('hidden');

      // Update rankings
      updateRanking(state.ranking, 'ranking-list');
      updateRanking(state.ranking, 'result-ranking');

      if (state.status === 'lobby') {
        showLobby(state);
      } 
      else if (state.status === 'asking' && state.currentQuestion) {
        showQuestion(state);
      } 
      else if (state.status === 'revealed' && state.revealedQuestion) {
        showResult(state);
      }
    }

    function showLobby(state) {
      lobbySection.classList.remove('hidden');
      lobbySection.style.display = 'flex';
      document.getElementById('lobby-player-count').textContent = state.players.length;
      
      const playersHtml = state.players.map(p => `
        <div class="player-avatar" style="width: 3.5rem; height: 3.5rem; font-size: 1.25rem;">
          ${p.nickname.charAt(0).toUpperCase()}
        </div>
      `).join('');
      document.getElementById('lobby-players').innerHTML = playersHtml;
    }

    function showQuestion(state) {
      questionSection.classList.remove('hidden');
      questionSection.style.display = 'flex';
      const q = state.currentQuestion;
      
      const typeLabels = {
        'IMAGE_CLASSIFY': 'üñºÔ∏è Classificar Imagem',
        'TEXT_CLASSIFY': 'üìù Classificar Texto',
        'HALLUCINATION_DETECT': 'üîç Detectar Alucina√ß√£o',
        'LGPD_TRAFFIC_LIGHT': 'üö¶ LGPD na Escola'
      };
      
      document.getElementById('question-type').textContent = typeLabels[q.type] || q.type;
      document.getElementById('question-counter').textContent = `Pergunta ${q.index + 1} de ${q.total}`;
      document.getElementById('question-prompt').textContent = q.prompt;
      
      // Image
      const imgSection = document.getElementById('question-image');
      if (q.imageUrl) {
        imgSection.classList.remove('hidden');
        document.getElementById('question-img').src = q.imageUrl;
      } else {
        imgSection.classList.add('hidden');
      }
      
      // Options (display only)
      const optionsHtml = q.options.map((opt, i) => `
        <div class="btn-option screen-option" style="cursor: default;">
          <span class="option-letter">${String.fromCharCode(65 + i)}</span>
          <span style="flex: 1;">${opt}</span>
        </div>
      `).join('');
      document.getElementById('options-container').innerHTML = optionsHtml;
      
      // Update counters
      document.getElementById('answered-count').textContent = state.answeredCount;
      document.getElementById('total-players').textContent = state.totalPlayers;
    }

    function showResult(state) {
      resultSection.classList.remove('hidden');
      resultSection.style.display = 'flex';
      const q = state.revealedQuestion;
      
      const typeLabels = {
        'IMAGE_CLASSIFY': 'üñºÔ∏è Classificar Imagem',
        'TEXT_CLASSIFY': 'üìù Classificar Texto',
        'HALLUCINATION_DETECT': 'üîç Detectar Alucina√ß√£o',
        'LGPD_TRAFFIC_LIGHT': 'üö¶ LGPD na Escola'
      };
      
      document.getElementById('result-type').textContent = typeLabels[q.type] || q.type;
      document.getElementById('result-counter').textContent = `Pergunta ${q.index + 1} de ${q.total}`;
      document.getElementById('result-prompt').textContent = q.prompt;
      
      // Image
      const imgSection = document.getElementById('result-image');
      if (q.imageUrl) {
        imgSection.classList.remove('hidden');
        document.getElementById('result-img').src = q.imageUrl;
      } else {
        imgSection.classList.add('hidden');
      }
      
      // Stats bars
      const statsHtml = q.stats.map((s, i) => {
        const isCorrect = i === q.correctOption;
        return `
          <div class="stat-bar-container" style="padding: 1rem 1.25rem;">
            <span class="stat-bar-label" style="width: 2.5rem; height: 2.5rem; font-size: 1.25rem; ${isCorrect ? 'background: var(--success);' : ''}">
              ${String.fromCharCode(65 + i)}
            </span>
            <div class="stat-bar-track screen-stat-bar">
              <div class="stat-bar-fill ${isCorrect ? 'correct' : ''}" style="width: ${s.percentage}%;"></div>
            </div>
            <span class="stat-bar-percentage" style="font-size: 1.25rem; width: 4.5rem;">${s.percentage}%</span>
            <span class="stat-bar-count" style="font-size: 1rem;">(${s.count})</span>
          </div>
        `;
      }).join('');
      document.getElementById('stats-container').innerHTML = statsHtml;
      
      // Correct answer
      document.getElementById('correct-answer').textContent = 
        `${String.fromCharCode(65 + q.correctOption)}) ${q.options[q.correctOption]}`;
      
      // Explanation
      document.getElementById('explanation').textContent = q.explanation;
    }

    function showGameOver(data) {
      lobbySection.classList.add('hidden');
      questionSection.classList.add('hidden');
      resultSection.classList.add('hidden');
      gameoverSection.classList.remove('hidden');
      gameoverSection.style.display = 'flex';
      
      const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];
      
      const rankingHtml = data.ranking.slice(0, 10).map((p, i) => {
        let rankClass = '';
        if (i === 0) rankClass = 'gold';
        else if (i === 1) rankClass = 'silver';
        else if (i === 2) rankClass = 'bronze';
        
        return `
          <div class="ranking-item ${rankClass} screen-ranking-item">
            <span class="screen-ranking-position">${medals[i] || ''}</span>
            <span class="ranking-name" style="font-size: 1.25rem;">${p.nickname}</span>
            <span class="ranking-score" style="font-size: 1.5rem;">${p.score} pts</span>
          </div>
        `;
      }).join('');
      
      document.getElementById('final-ranking').innerHTML = rankingHtml;
      
      // Confetti celebration
      createConfetti(50);
    }

    function updateRanking(ranking, elementId) {
      const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
      const el = document.getElementById(elementId);
      
      if (!ranking || ranking.length === 0) {
        el.innerHTML = `<p class="text-caption text-center" style="padding: 1.5rem; color: var(--text-muted);">Aguardando...</p>`;
        return;
      }
      
      const html = ranking.slice(0, 5).map((p, i) => {
        let rankClass = '';
        if (i === 0) rankClass = 'gold';
        else if (i === 1) rankClass = 'silver';
        else if (i === 2) rankClass = 'bronze';
        
        return `
          <div class="ranking-item ${rankClass} screen-ranking-item">
            <span class="screen-ranking-position">${medals[i]}</span>
            <span class="ranking-name">${p.nickname}</span>
            <span class="ranking-score">${p.score}</span>
          </div>
        `;
      }).join('');
      el.innerHTML = html;
    }

    // Confetti effect
    function createConfetti(count = 30) {
      const container = document.getElementById('confetti-container');
      const colors = ['#3B82F6', '#60A5FA', '#22C55E', '#FBBF24', '#F87171', '#A855F7'];
      
      for (let i = 0; i < count; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-piece';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-20px';
        confetti.style.width = (10 + Math.random() * 10) + 'px';
        confetti.style.height = (10 + Math.random() * 10) + 'px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        
        container.appendChild(confetti);
        
        confetti.animate([
          { 
            opacity: 1, 
            transform: `translateY(0) rotate(0deg)`,
          },
          { 
            opacity: 0, 
            transform: `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 1080}deg)`,
          }
        ], {
          duration: 3000 + Math.random() * 3000,
          easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
          delay: i * 30
        }).onfinish = () => confetti.remove();
      }
    }
  </script>
</body>
</html>
